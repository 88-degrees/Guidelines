## 面向切面编程

* [Engilsh Version](./aopguide.md)

AOP 为 **Aspect Oriented Programming** 的缩写，意为：面向切面编程，通过预编译方式和运行期动态代理实现程序功能的统一维护的一种技术。
AOP 是 OOP 的延续，是软件开发中的一个热点，也是 **Spring** 框架中的一个重要内容，是函数式编程的一种衍生范型。
利用 AOP 可以对业务逻辑的各个部分进行隔离，从而使得业务逻辑各部分之间的耦合度降低，
提高程序的可重用性，同时提高了开发的效率。

“面向切面编程”，这样的名字并不是非常容易理解，且容易产生一些误导。
有些人认为“ OOP / OOD ”即将落伍，AOP 是新一代软件开发方式”。
显然，发言者并没有理解 AOP 的含义。
Aspect，的确是“方面”的意思。不过，汉语传统语义中的“方面”，
大多数情况下指的是一件事情的不同维度、或者说不同角度上的特性，
比如我们常说：“这件事情要从几个方面来看待”，往往意思是：需要从不同的角度来看待同一个事物。
这里的“方面”，指的是事物的外在特性在不同观察角度下的体现。
而在 AOP 中，Aspect 的含义，可能更多的理解为“切面”比较合适。

可以通过预编译方式和运行期动态代理实现在不修改源代码的情况下给程序动态统一添加功能的一种技术。
AOP 实际是 [GoF](http://c.biancheng.net/design_pattern/) 设计模式的延续，设计模式孜孜不倦追求的是调用者和被调用者之间的解耦，
提高代码的灵活性和可扩展性，AOP 可以说也是这种目标的一种实现。

在Spring中提供了面向切面编程的丰富支持，
允许通过分离应用的业务逻辑与系统级服务（例如审计 `auditing` 和事务 `transaction` 管理）进行内聚性的开发。
应用对象只实现它们应该做的：完成业务逻辑。仅此而已。
它们并不负责（甚至是意识）其它的系统级关注点，例如日志或事务支持。

### 主要功能

日志记录，性能统计，安全控制，事务处理，异常处理等等。

### 主要意图

将日志记录，性能统计，安全控制，事务处理，异常处理等代码从业务逻辑代码中划分出来，
通过对这些行为的分离，我们希望可以将它们独立到非指导业务逻辑的方法中，
进而改变这些行为的时候不影响业务逻辑的代码。

### 区分

AOP、OOP 在字面上虽然非常类似，但却是面向不同领域的两种设计思想。
OOP（面向对象编程）针对业务处理过程的实体及其属性和行为进行抽象封装，
以获得更加清晰高效的逻辑单元划分。
而 AOP 则是针对业务处理过程中的切面进行提取，
它所面对的是处理过程中的某个步骤或阶段，以获得逻辑过程中各部分之间低耦合性的隔离效果。
这两种设计思想在目标上有着本质的差异。
上面的陈述可能过于理论化，举个简单的例子，对于“雇员”这样一个业务实体进行封装，自然是OOP/OOD的任务，
我们可以为其建立一个 **Employee** 类，并将 **雇员** 相关的属性和行为封装其中。
而用 AOP 设计思想对 **雇员** 进行封装将无从谈起。
同样，对于“权限检查”这一动作片断进行划分，则是AOP的目标领域。
而通过 OOD / OOP 对一个动作进行封装，则有点不伦不类。
换而言之，OOD / OOP 面向名词领域，AOP 面向动词领域。

### 关系

很多人在初次接触 AOP 的时候可能会说，AOP 能做到的，
一个定义良好的 OOP 的接口也一样能够做到，我想这个观点是值得商榷的。
AOP和定义良好的 OOP 的接口可以说都是用来解决并且实现需求中的横切问题的方法。
但是对于 OOP 中的接口来说，它仍然需要我们在相应的模块中去调用该接口中相关的方法，
这是 OOP 所无法避免的，并且一旦接口不得不进行修改的时候，所有事情会变得一团糟；
AOP 则不会这样，你只需要修改相应的 Aspect，再重新编织（Weave）即可。 
当然，AOP 也绝对不会代替 OOP。
核心的需求仍然会由 OOP 来加以实现，而 AOP 将会和 OOP 整合起来，以此之长，补彼之短。

![aspect](https://flowframework.readthedocs.io/en/stable/_images/AOPFramework_ProxyBuildingProcess.png)

AOP 非常适合开发 J2EE 容器服务器。

传统的程序通常表现出一些不能自然地适合单一的程序模块或者是几个紧密相关的程序模块的行为，
AOP 将这种行为称为横切，它们跨越了给定编程模型中的典型职责界限。
横切行为的实现都是分散的，软件设计师会发现这种行为难以用正常的逻辑来思考、实现和更改。

最常见的一些横切行为如下面这些：
1. 日志记录，跟踪，优化和监控。
2. 事务的处理。
3. 持久化。
4. 性能的优化。
5. 资源池，如数据库连接池的管理。
6. 系统统一的认证、权限管理等。
7. 应用系统的异常捕捉及处理。
8. 针对具体行业应用的横切行为。

AOP 是一个概念，并没有设定具体语言的实现，它能克服那些只有单继承特性语言的缺点（如 **Java**），
面向过程编程离我们已经有些遥远，面向对象编程正主宰着软件世界。
当每个新的软件设计师都被要求掌握如何将需求功能转化成一个个类，
并且定义它们的数据成员、行为，以及它们之间复杂的关系的时候，
面向切面编程（Aspect-Oriented Programming，AOP）为我们带来了新的想法、新的思想、新的模式。
 
如果说面向对象编程是关注将需求功能划分为不同的并且相对独立，封装良好的类，
并让它们有着属于自己的行为，依靠继承和多态等来定义彼此的关系的话；
那么面向切面编程则是希望能够将通用需求功能从不相关的类当中分离出来，
能够使得很多类共享一个行为，一旦发生变化，不必修改很多类，而只需要修改这个行为即可。
有了 AOP，我们可以定义交叉的关系，并将这些关系应用于跨模块的、彼此不同的对象模型。
AOP 同时还可以让我们层次化功能性而不是嵌入功能性，从而使得代码有更好的可读性和易于维护。
它会和面向对象编程合作得很好。

AOP 是一个概念，一个规范，本身并没有设定具体语言的实现，这实际上提供了非常广阔的发展的空间。

- **Aspect**：Aspect 声明类似于 Java 中的类声明，在 Aspect 中会包含着一些 Pointcut 以及相应的 Advice。
- **Joint Point**：表示在程序中明确定义的点，典型的包括方法调用，对类成员的访问以及异常处理程序块的执行等等，
  它自身还可以嵌套其它 `joint point` 。
- **Pointcut**：表示一组 `joint point`，这些 `joint point` 或是通过逻辑关系组合起来，或是通过通配、正则表达式等方式集中起来，它定义了相应的 Advice 将要发生的地方。
- **Advice**：Advice 定义了在 pointcut 里面定义的程序点具体要做的操作，它通过 `before`、`after` 和 `around` 来区别是在每个 `joint point` 之前、之后还是代替执行的代码。
